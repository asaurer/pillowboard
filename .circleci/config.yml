version: 2
jobs:
  build:
    docker:
      - image: circleci/clojure:lein-2.7.1
    environment:
      LEIN_ROOT: nbd
      JVM_OPTS: -Xmx3200m
    steps: # commands that comprise the `build` job
      - checkout # check out source code to working directory
      - restore_cache: # restores saved cache if checksum hasn't changed since the last run
          key: dashboard-{{ checksum "board/project.clj" }}
      - run: cd board && lein deps
      - save_cache: # generate and store cache in the .m2 directory using a key template
          paths:
            - ~/.m2
          key: dashboard-{{ checksum "board/project.clj" }}
      - run: cd board && lein uberjar
      - store_artifacts: # upload test results for display in Test Summary
          path: board/target/dashboard-standalone.jar
          destination: uberjar
      - setup_remote_docker:
          docker_layer_caching: true
      - run: docker login -u $DOCKER_USER -p $DOCKER_PASS
      - run: docker-compose -f docker-compose.test.yml build --pull --no-cache
      - run: docker push jerben/dashboard:latest
      #- run: sudo apt install rsync -y
      - run: ssh root@51.15.110.49 "mkdir -p /usr/share/docker/dashboard/ && rm -f /usr/share/docker/dashboard/docker-compose.test.yml"
      - run: ssh root@51.15.110.49 "rm -f /usr/share/docker/dashboard/.env"
      - run: ssh root@51.15.110.49 "echo DATABASE_URL=$DATABASE_URL > /usr/share/docker/dashboard/.env"
      - run: ssh root@51.15.110.49 "echo DATABASE_NAME=staging >> /usr/share/docker/dashboard/.env"
      - run: rsync -avz docker-compose.test.yml root@51.15.110.49:/usr/share/docker/dashboard/
      - run: ssh root@51.15.110.49 "docker login -u $DOCKER_USER -p $DOCKER_PASS"
      - run: ssh root@51.15.110.49 "cd /usr/share/docker/dashboard/ && docker-compose -f docker-compose.test.yml pull && docker-compose -f docker-compose.test.yml down && docker-compose -f docker-compose.test.yml up -d"
